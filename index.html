<!DOCTYPE html>
<html>
  <head>
    <title>WebGPU GPT Model Demo</title>
    <meta
      http-equiv="origin-trial"
      content="Anx9P4m5tzLOL/wLICKy/mA+DRyoSsTkyqmnK5t+S7oyw7A2SeBI2jO4LKqoQiQgChP2MTtqMNKofelMwvGtPQsAAABKeyJvcmlnaW4iOiJodHRwczovL2ttZWFucy5vcmc6NDQzIiwiZmVhdHVyZSI6IldlYkdQVSIsImV4cGlyeSI6MTY5MTcxMTk5OX0="
    />
    <script src="tokenizer.js"></script>
    <script src="instructions.js"></script>
    <script src="model.js"></script>
    <script src="visuals.js"></script>
    <script src="globals.js"></script>
  </head>
  <body style="background-color: black;">
    <p style="position: absolute; bottom: 8px; left: 10px; font-size: 15px; color: gray; font-family: monospace; margin: 0;">@willdepue x gpt-2 base</p>
    <p id="prompt" rows="15" cols="50" disabled style="
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0; 
      right: 0;
      width: 1024px; 
      height: 1280px;
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto; 
      margin-right: auto;
      color: white;
      word-break: break-all;
      font-size: 24px; 
      font-family: 'Times New Roman', Times, serif; 
      line-height: 30px; 
      /* z-index: 10; */
    ">Loading...</p>
    <div id="visualsContainer" style="position: absolute; 
      top: 0;
      bottom: 0;
      left: 0; 
      right: 0; 
      margin-left: auto; 
      margin-right: auto; 
      margin-top: auto; 
      margin-bottom: auto; 
      width: 768px; 
      border: 1px solid white;
      height: 1024px;
      background-color: transparent;
      /* z-index: -10; */
      "
    >
    <canvas id="visualsCanvas"></canvas>
    </div>
    <script>
      const promptTextarea = document.getElementById("prompt");

      // Check for WebGPU support
      if (!navigator.gpu) {
        throw new Error("WebGPU is not supported");
      }

      // If less than 4k screen, scale down visuals
      console.log('width, height', window.innerWidth, window.innerHeight);
      if (window.innerWidth < 1200 || window.innerHeight < 1500 ) {
        document.body.style.zoom = "50%";
      } else if ( window.innerHeight < 2000 ) {
        document.body.style.zoom = "80%";
      }


      async function loop() {
        const GPTModel = new GPT('gpt2', 'bpe');
        await GPTModel.initialize();
        
        async function run() {
          const visuals = new Visuals(GPTModel);
          visuals.init();
          visuals.render();

          const prompt = "What is the answer to life, the universe, and everything?"
          const promptLength = GPTModel.tokenizer.encode(prompt).length;
          console.log(promptLength);
          promptTextarea.innerHTML = prompt;
          const numTokens = 1024 - promptLength;

          const topK = 3
          const temperature = 1
          const textStream = GPTModel.generate(prompt, numTokens, topK, temperature);

          for await (const text of textStream) {
            promptTextarea.innerHTML += text;
            visuals.render();
          }
        }
        
        while (true) {
          await run();
        }
      }

      loop()
    </script>
  </body>
</html>
